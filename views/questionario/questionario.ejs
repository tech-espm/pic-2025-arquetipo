<style>
  #questionario {
    --cor-destaque: <%- item.cordestaque %>;
    --cor-texto-destaque: <%- item.cortextodestaque %>;
    --cor-fundo-card: <%- item.corfundocard %>;
    --cor-texto-card: <%- item.cortextocard %>;
    --cor-fundo-pagina: <%- item.corfundopagina %>;
    min-height: 100vh;
  }

  body {
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    min-height: 100vh;
    color: var(--cor-texto-card);
    transition: background-image 0.4s ease-in-out;
  }

  .tela {
    display: none;
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  .tela.ativa {
    display: block;
    opacity: 1;
  }

  .tela>.container-fluid>.row {
    min-height: 100vh;
  }

  .card-questao {
    background-color: var(--cor-fundo-pagina);
  }


  .zero-padding {
    padding: 0 !important;
  }

  .alternativa-card {
    display: block;
    width: 100%;
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 0.5rem;
    background-color: var(--cor-fundo-card);
    color: var(--cor-texto-card);
    border-color: var(--cor-texto-card);
    border-width: 3px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.15s ease-in-out;
    font-size: 1.1rem;
  }

  .alternativa-card:hover {
    background-color: #ffffff;
    border-color: rgba(255, 255, 255, 0.5);
  }

  .alternativa-card.selecionada {
    color: var(--cor-texto-destaque);
    font-weight: bolder;
    border-color: var(--cor-destaque);
  }

  .btn-navegacao-avancar {
    background-color: var(--cor-destaque);
    color: var(--cor-fundo-card);
    font-weight: bolder;
  }

  .btn-navegacao-voltar {
    background-color: var(--cor-fundo-card);
    color: var(--cor-texto-card);
    font-weight: bolder;
  }

  .cor-texto-introducao {
    color: white;
  }

</style>
  
  
  
  <div id="questionario">
    <div class="tela ativa" id="introducao" data-background="<%- staticRoot %>/img/questionario/introducao/<%- (item && item.id) %>.jpg?v=<%- (item && item.versaointroducao) %>">
      <div class="container">
        <div class="row justify-content-center align-items-center vh-100">
          <div class="col-12 col-md-8 col-lg-6 text-center">
            <div class="cor-texto-introducao"><%- item.textointroducao %></div>
            <button class="btn btn-primary btn-lg mt-3" onclick="questionario.avancar()">COMEÇAR</button>
          </div>
        </div>
      </div>
    </div>


    <% if (loginESPM && loginExterno && !dadosToken) { %>
    <div class="tela" id="identificacao" data-background="<%- staticRoot %>/img/questionario/introducao/<%- (item && item.id) %>.jpg?v=<%- (item && item.versaointroducao) %>">
      <div class="container">
        <div class="row justify-content-center align-items-center vh-100">
          <div class="col-12 col-md-8 col-lg-6 text-center">
            <div class="cor-texto-introducao"> Você é <strong>aluno</strong> ou <strong>funcionário</strong> da ESPM?</div>
            <a class="btn btn-primary btn-lg mt-3" href="<%- urlCallback %>">Sim, sou da ESPM</a>
            <button class="btn btn-primary btn-lg mt-3" onclick="questionario.avancar()">Não, sou visitante</button>
          </div>
        </div>
      </div>
    </div>
    <% } %>
  

    <% if (loginExterno && !dadosToken) { %>
    
    <div class="tela" id="cadastro" data-background="<%- staticRoot %>/img/questionario/introducao/<%- (item && item.id) %>.jpg?v=<%- (item && item.versaointroducao) %>">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-md-8 col-lg-6 d-flex flex-column justify-content-center">
            <div class="card o-hidden border-0 shadow-lg my-5">
              <div class="card-body p-0">
                <div class="row justify-content-center align-items-center">
                  <div class="col-sm-12">
                    <div class="p-5">
                      <div class="mb-4 text-center">
                        <img style="width: 100%; max-width: 250px;" alt="Logo ESPM" src="<%- staticRoot %>/img/logo.png" />
                      </div>
                      <form method="POST" id="formcadastro">
                        <input type="hidden" id="idquestionario" name="idquestionario" value="<%- item.id %>">

                        <div class="form-group">
                          <input type="text" class="form-control" id="nome" name="nome" placeholder="Nome" required>
                        </div>
                        <div class="form-group">
                          <input type="email" class="form-control" id="email" name="email" placeholder="Email" required>
                        </div>
                        <div class="form-group">
                          <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="Telefone" required>
                        </div>
                        <input type="hidden" id="aluno" name="aluno" value="false">
                        <button type="submit" class="btn btn-primary btn-user btn-block">
                          Começar
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <% } else if (dadosToken) { %>
    <div>
      <form id="formcadastro" style="display: none;">
        <input type="text" id="nome" name="nome" value="<%- dadosToken.nome %>">
        <input type="email" id="email" name="email" value="<%- dadosToken.email %>">
        <input type="text" id="aluno" name="aluno" value="<%- dadosToken.aluno %>">
        <input type="tel" id="telefone" name="telefone" value="">
      </form>
    </div>
      
    <% } %>


    <% item.questoes.forEach((questao) => { %>
    <div class="tela questao" id="<%- questao.id %>" data-questao="<%- questao.id %>" data-obrigatoria="true" data-background="<%- staticRoot %>/img/questionario/<%- (item && item.id) %>.jpg?v=<%- (item && item.versaoquestionario) %>">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-md-8 col-lg-6 d-flex flex-column justify-content-center p-4">
            <div class="card">
              <!-- <div class="card-header">
                Header loading
              </div> -->
              <div class="card-body py-0">
                <h2 class="h4 fw-normal mt-4 mb-2"><%- questao.titulo %></h2>
                <p class="lead fs-5 mt-2 mb-4"><%- questao.enunciado %></p>

                <div class="alternativas-container" id="alternativas-q-<%- questao.id %>">
                  <% questao.alternativas.forEach((alt) => { %>
                    <div class="form-check-alternativa">
                    <input class="form-check-input d-none q-<%- questao.id %>" type="radio" name="questao-<%- questao.id %>" id="<%- questao.id + '-' + alt.arquetipoid %>" value="<%- alt.arquetipoid %>" onchange="questionario.registrarResposta('<%- questao.id %>', '<%- alt.arquetipoid %>')" <%- (resposta && resposta[questao.id] == alt.arquetipoid) ? 'checked' : '' %>>

                    <label class="form-check-label alternativa-card <%- (resposta && resposta[questao.id] == alt.arquetipoid) ? 'selecionada' : '' %>" for="<%- questao.id + '-' + alt.arquetipoid %>">
                      <%- alt.texto %>
                    </label>
                  </div>
                  <% }) %>
                </div>
                <div class="row" style="margin: 1.5rem -1.25rem 0;">
                  <div class="col-6 btn btn-navegacao-voltar border-0 rounded-0 p-3" onclick="questionario.voltar()">
                    <span class="fw-bold">Voltar</span>
                  </div>
                  <div class="col-6 btn btn-navegacao-avancar border-0 rounded-0 p-3" onclick="questionario.avancar()">
                    <span class="fw-bold">Avançar</span>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% }) %>

    <div class="tela" id="conclusao" data-background="<%- staticRoot %>/img/questionario/<%- (item && item.id) %>.jpg?v=<%- (item && item.versaoquestionario) %>">
      <div class="container">
        <div class="row">
          <div class="col-8" id="arquetipo"></div>
          <div class="col-4"><img id="imgconclusao" src="" alt=""></div>
        </div>
      </div>
    </div>

  </div> 
  <%- contentFor("scripts") %>
<script>
  //<![CDATA[
  "use strict";

  class Questionario {
    constructor(selector) {
      this.telas = document.querySelectorAll(selector);
      this.telaAtual = 0;
      
      this.dadosToken = <%- dadosToken ? JSON.stringify(dadosToken) : 'null' %>;
      this.externo = !this.dadosToken;

      //<% if (resposta) { %>
      this.resposta = <%- JSON.stringify(resposta) %>;
      //<% } else{ %>
      this.resposta = {};
      //<% } %>

      this.configurarValidacao();


      if (this.dadosToken) {
        const primeiraQuestaoIndex = Array.from(this.telas).findIndex(t => t.classList.contains("questao"));
        if (primeiraQuestaoIndex > -1) {
          this.mostrarTela(primeiraQuestaoIndex);
        } else {
          this.mostrarTela(0); 
        }
      } else {
        this.mostrarTela(0);
      }
    }

    mostrarTela(index) {
      this.telas.forEach((t, i) => t.classList.toggle("ativa", i === index));
      this.telaAtual = index;
      
      const novoBackground = this.telas[index].dataset.background;
      
      if (novoBackground) {
        document.body.style.backgroundImage = `url('${novoBackground}')`;
      } else {
        document.body.style.backgroundImage = 'none';
      }
    }

    avancar() {
      if (!this.validarTela() && this.telas[this.telaAtual].id !== 'cadastro') {
          return;
      }

      if (this.telaAtual + 1 < this.telas.length) {
        this.mostrarTela(this.telaAtual + 1);
        if (this.telas[this.telaAtual].id === "conclusao") this.gerarConclusao();
      }
    }

    voltar() {
      if (this.telaAtual > 0) this.mostrarTela(this.telaAtual - 1);
    }

    registrarResposta(questaoId, alternativaId) {
      this.resposta[questaoId] = alternativaId;

      const idInput = `${questaoId}-${alternativaId}`;
      const input = document.getElementById(idInput);

      const containerAlternativas = document.getElementById(`alternativas-q-${questaoId}`);
      if (containerAlternativas) {
        containerAlternativas.querySelectorAll('.alternativa-card').forEach(label => {
          label.classList.remove('selecionada');
        });
      }
      
      if (input) {
        const label = document.querySelector(`label[for='${idInput}']`);
        if (label) {
          label.classList.add('selecionada');
        }

        $(`#${idInput}`).prop("checked", true);
      }
    }

    validarTela() {
      const tela = this.telas[this.telaAtual];

      if (tela.id === "cadastro") {
          return $("#formcadastro").valid();
      }

      const questaoId = tela.dataset.questao;
      if (tela.classList.contains("questao") && !this.resposta[questaoId]) {
        Swal.fire("Atenção", "Selecione uma alternativa antes de avançar.", "warning");
        return false;
      }
      return true;
    }

    configurarValidacao() {
      //<% if (loginExterno && !dadosToken) { %>
        $("#formcadastro").validate({
          errorElement: "div",
          errorClass: "invalid-feedback",
          highlight: el => $(el).addClass("is-invalid").removeClass("is-valid"),
          unhighlight: el => $(el).removeClass("is-invalid").addClass("is-valid"),
          errorPlacement: (error, el) => error.insertAfter(el),

          submitHandler: (form) => {
            if (JsonWebApi.active) return;
            
            this.avancar();
          }
        });
      //<% } %>
    }

    preencherForm(res) {
      if (!res) return;
      for (const questaoid in res) this.registrarResposta(questaoid, res[questaoid]);
    }

    gerarConclusao() {
      if (JsonWebApi.active) return;
      
      let req = {
        resposta : this.resposta,
        idquestionario: <%- item.id %>,
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        telefone: document.getElementById("telefone").value || null, 
        aluno: $("#aluno").val() == "true" ? true : false,
        externo: this.externo
      };

      JsonWebApi.post("<%- root %>/api/submissao/criarOuEditar", req, (response) => {
        if (response.success) {
          const arquetipo = response.value;
          $("#imgconclusao").attr("src", `<%- staticRoot %>/img/arquetipo/${arquetipo.id}.jpg?v=${arquetipo.versao}`);
          $("#arquetipo").html(`<h1>${arquetipo.nome}</h1><div>${arquetipo.descricaocompleta}</div>`);
        } else {
          Swal.error(response.value + " " + emoji.sad);
        }
      });
    }
  }
  
  //]]>
  const questionario = new Questionario(".tela");
</script>